<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Money Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body class="bg-slate-100">
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;

/* ------------------ CONFIG ------------------ */
const DEFAULT_CATEGORIES = [
  "ðŸ½ï¸ Food", "ðŸ›ï¸ Shopping", "ðŸš‡ Transportation",
  "â›½ Gasoline", "ðŸ“± Phone", "ðŸ’³ Charge", "ðŸ“¦ Others"
];

const DEFAULT_METHODS = [
  "ðŸ’µ Cash/QR", "ðŸ’³ Credit Card", "â™¦ï¸ TrueMoney", "ðŸ° Rabbit Card"
];

/* ------------------ HELPERS ------------------ */
function getCycleRange() {
  const now = new Date();
  const d = now.getDate();
  let start, end;

  if (d >= 27) {
    start = new Date(now.getFullYear(), now.getMonth(), 27);
    end = new Date(now.getFullYear(), now.getMonth() + 1, 26);
  } else {
    start = new Date(now.getFullYear(), now.getMonth() - 1, 27);
    end = new Date(now.getFullYear(), now.getMonth(), 26);
  }
  return { start, end };
}

function inCycle(date) {
  const { start, end } = getCycleRange();
  const d = new Date(date);
  return d >= start && d <= end;
}

/* ------------------ APP ------------------ */
function App() {
  const [budget, setBudget] = useState(0);
  const [categories, setCategories] = useState(DEFAULT_CATEGORIES);
  const [methods, setMethods] = useState(DEFAULT_METHODS);
  const [tx, setTx] = useState([]);
  const [view, setView] = useState("home");

  const [form, setForm] = useState({
    type: "expense",
    amount: "",
    category: categories[0],
    method: methods[0],
    date: new Date().toISOString().slice(0,10),
    note: ""
  });

  /* ---------- storage ---------- */
  useEffect(() => {
    const d = JSON.parse(localStorage.getItem("moneyData") || "{}");
    if (d.budget) setBudget(d.budget);
    if (d.tx) setTx(d.tx);
    if (d.categories) setCategories(d.categories);
    if (d.methods) setMethods(d.methods);
  }, []);

  useEffect(() => {
    localStorage.setItem("moneyData", JSON.stringify({
      budget, tx, categories, methods
    }));
  }, [budget, tx, categories, methods]);

  /* ---------- calculations ---------- */
  const cycleTx = tx.filter(t => inCycle(t.date));

  const sum = (type) =>
    cycleTx.filter(t => t.type === type)
           .reduce((s,t)=>s+t.amount,0);

  const income = sum("income");
  const expense = sum("expense");
  const saving = sum("saving");
  const remaining = income - expense - saving;
  const percent = budget ? (expense / budget) * 100 : 0;

  const groupBy = (key) => {
    const out = {};
    cycleTx.filter(t=>t.type==="expense").forEach(t=>{
      out[t[key]] = (out[t[key]]||0)+t.amount;
    });
    return out;
  };

  /* ---------- actions ---------- */
  function addTx() {
    if (!form.amount) return;
    setTx([{...form, id:Date.now(), amount:+form.amount}, ...tx]);
    setForm({...form, amount:"", note:""});
  }

  /* ------------------ UI ------------------ */
  return (
    <div className="max-w-md mx-auto p-4 pb-24">
      <header className="flex justify-between mb-4">
        <h1 className="text-xl font-bold">ðŸ’° Money Tracker</h1>
        <button onClick={()=>setView(view==="home"?"settings":"home")}
          className="text-sm text-indigo-600">
          {view==="home"?"Settings":"Back"}
        </button>
      </header>

      {view==="home" && (
      <>
        {/* Budget */}
        <div className="bg-white p-4 rounded-xl shadow mb-4">
          <p className="text-sm text-gray-500">Budget</p>
          <p className="text-2xl font-bold">à¸¿{budget.toLocaleString()}</p>
          <div className="mt-2 bg-gray-200 h-2 rounded">
            <div className="h-2 bg-indigo-500 rounded"
              style={{width:Math.min(percent,100)+"%"}} />
          </div>
          <p className="text-xs mt-1">{percent.toFixed(1)}%</p>
        </div>

        {/* Summary */}
        <div className="grid grid-cols-2 gap-2 mb-4">
          <Card label="Income" val={income} />
          <Card label="Expense" val={expense} />
          <Card label="Saving" val={saving} />
          <Card label="Remaining" val={remaining} />
        </div>

        {/* Add */}
        <div className="bg-white p-4 rounded-xl shadow mb-4 space-y-2">
          <select className="w-full border p-2 rounded"
            value={form.type}
            onChange={e=>setForm({...form,type:e.target.value})}>
            <option value="expense">Expense</option>
            <option value="income">Income</option>
            <option value="saving">Saving</option>
          </select>

          <input className="w-full border p-2 rounded"
            placeholder="Amount (à¸¿)"
            type="number"
            value={form.amount}
            onChange={e=>setForm({...form,amount:e.target.value})} />

          <select className="w-full border p-2 rounded"
            value={form.category}
            onChange={e=>setForm({...form,category:e.target.value})}>
            {categories.map(c=><option key={c}>{c}</option>)}
          </select>

          <select className="w-full border p-2 rounded"
            value={form.method}
            onChange={e=>setForm({...form,method:e.target.value})}>
            {methods.map(m=><option key={m}>{m}</option>)}
          </select>

          <button onClick={addTx}
            className="w-full bg-indigo-600 text-white p-2 rounded">
            Add
          </button>
        </div>

        {/* Lists */}
        <List title="By Category" data={groupBy("category")} />
        <List title="By Payment" data={groupBy("method")} />
      </>
      )}

      {view==="settings" && (
        <div className="bg-white p-4 rounded-xl shadow space-y-4">
          <div>
            <label className="text-sm">Budget</label>
            <input type="number" className="w-full border p-2 rounded"
              value={budget}
              onChange={e=>setBudget(+e.target.value)} />
          </div>
        </div>
      )}
    </div>
  );
}

/* ------------------ SMALL COMPONENTS ------------------ */
const Card = ({label,val}) => (
  <div className="bg-white p-3 rounded-xl shadow">
    <p className="text-xs text-gray-500">{label}</p>
    <p className="font-bold">à¸¿{val.toLocaleString()}</p>
  </div>
);

const List = ({title,data}) => (
  <div className="bg-white p-4 rounded-xl shadow mb-4">
    <h3 className="font-semibold mb-2">{title}</h3>
    {Object.entries(data).map(([k,v])=>(
      <div key={k} className="text-sm flex justify-between">
        <span>{k}</span><span>à¸¿{v.toLocaleString()}</span>
      </div>
    ))}
  </div>
);

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
