<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Money Tracker</title>

<!-- React -->
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<style>
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: #f4f4f4;
}

header {
  height: 52px;
  background: #fff;
  display: flex;
  align-items: center;
  padding: 0 12px;
  border-bottom: 1px solid #ddd;
}

header h1 {
  flex: 1;
  text-align: center;
  font-size: 16px;
}

.menu {
  font-size: 22px;
  background: none;
  border: none;
}

main {
  padding: 12px;
  padding-bottom: 90px;
}

.txn {
  background: #fff;
  padding: 10px;
  border-radius: 8px;
  display: flex;
  justify-content: space-between;
  margin-bottom: 6px;
}

.amount {
  font-weight: 600;
}

.expense { color: #e53935; }
.income { color: #2e7d32; }
.saving { color: #1565c0; }
.charge { color: #6a1b9a; }

.date-title {
  font-weight: bold;
  margin: 12px 0 6px;
}

nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #fff;
  display: flex;
  border-top: 1px solid #ddd;
}

nav button {
  flex: 1;
  border: none;
  background: none;
  padding: 10px;
  font-size: 12px;
}

.active {
  color: #4caf50;
  font-weight: bold;
}

.fab {
  position: fixed;
  bottom: 90px;
  right: 20px;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: #4caf50;
  color: #fff;
  font-size: 32px;
  border: none;
}

.overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.4);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 10;
}

.sheet {
  background: #fff;
  width: 92%;
  max-height: 90%;
  overflow-y: auto;
  padding: 16px;
  border-radius: 12px;
}

input, select {
  width: 100%;
  padding: 10px;
  margin: 6px 0 12px;
  font-size: 16px;
}

.bar {
  height: 10px;
  background: #ddd;
  border-radius: 5px;
  overflow: hidden;
}

.bar div {
  height: 100%;
  background: #4caf50;
}

.drawer {
  position: fixed;
  top: 0;
  left: 0;
  width: 75%;
  height: 100%;
  background: #fff;
  padding: 16px;
  box-shadow: 2px 0 8px rgba(0,0,0,.2);
}

.menu-item {
  padding: 12px 0;
  font-size: 15px;
  border-bottom: 1px solid #eee;
}
  
</style>
</head>

<body>
<div id="app"></div>

<script type="text/babel">
const { useState, useEffect } = React;

function MenuItem({label, onClick}) {
  
  return <div className="menu-item" onClick={onClick}>{label}</div>;
}
  function openMenu(page) {
    setMenuPage(page);
    setDrawerOpen(false);
  }


function App() {

  const [tab, setTab] = useState("tx");
  const [showAdd, setShowAdd] = useState(false);
  const [showSettings, setShowSettings] = useState(false);

  const [settings, setSettings] = useState(
    JSON.parse(localStorage.getItem("settings")) || {
      cycleName: "Default Cycle",
      cycleStart: 27,
      cycleEnd: 26,
      categories: [
        { name: "ðŸ½ï¸ Food", budget: 5000 },
        { name: "ðŸ›ï¸ Shopping", budget: 3000 },
        { name: "ðŸš‡ Transportation", budget: 2000 },
        { name: "â›½ Gasoline", budget: 1500 },
        { name: "ðŸ“± Phone", budget: 1000 },
        { name: "ðŸ’³ Charge", budget: 4000 },
        { name: "ðŸ“¦ Others", budget: 2000 }
      ],
      payments: ["ðŸ’µ Cash/QR", "ðŸ’³ Credit Card", "â™¦ï¸ TrueMoney", "ðŸ° Rabbit Card"]
    }
  );

  const [txns, setTxns] = useState(
    JSON.parse(localStorage.getItem("txns")) || []
  );

  const [drawerOpen, setDrawerOpen] = useState(false);
  const [menuPage, setMenuPage] = useState(null);
  // menuPage: null | "budgetRatio" | "budgetTotal" | "usageTotal"
  //            | "budget" | "period" | "category" | "payment" | "about"
  
  useEffect(() => {
    localStorage.setItem("txns", JSON.stringify(txns));
    localStorage.setItem("settings", JSON.stringify(settings));
  }, [txns, settings]);

  function groupedTxns() {
    const map = {};
    txns
      .sort((a,b) => new Date(b.date) - new Date(a.date))
      .forEach(t => {
        map[t.date] = map[t.date] || [];
        map[t.date].push(t);
      });
    return map;
  }

  function totalBy(field) {
    return txns.filter(t => t.type === field)
      .reduce((s,t)=>s+t.amount,0);
  }

  
  return (
    <>
      <header>
        <button className="menu" onClick={() => setDrawerOpen(true)}>â˜°</button>
        <h1>
          {tab==="tx" && "Transactions"}
          {tab==="net" && "Net"}
          {tab==="usage" && "Category Usage"}
          {tab==="pay" && "Payment Usage"}
        </h1>
        <div style={{width:24}} />
      </header>

      {drawerOpen && (
        <div className="overlay" onClick={() => setDrawerOpen(false)}>
          <div className="drawer" onClick={e => e.stopPropagation()}>
            <h3>Money Mgmt</h3>

            <MenuItem label="ðŸ“Š Budget Ratio" onClick={() => openMenu("budgetRatio")} />
            <MenuItem label="ðŸ’° Budget (Total)" onClick={() => openMenu("budgetTotal")} />
            <MenuItem label="ðŸ“ˆ Usage (Total)" onClick={() => openMenu("usageTotal")} />

            <hr />

            <MenuItem label="ðŸ“‹ Budget" onClick={() => openMenu("budget")} />
            <MenuItem label="ðŸ—“ Period" onClick={() => openMenu("period")} />
            <MenuItem label="ðŸ· Category" onClick={() => openMenu("category")} />
            <MenuItem label="ðŸ’³ Payment Method" onClick={() => openMenu("payment")} />

            <hr />

            <MenuItem label="â„¹ï¸ About" onClick={() => openMenu("about")} />
            <MenuItem label="ðŸ’¬ Feedback" onClick={() => openMenu("feedback")} />
          </div>
        </div>
      )}

      <main>
        {tab==="tx" && Object.entries(groupedTxns()).map(([d,list])=>(
          <div key={d}>
            <div className="date-title">{d}</div>
            {list.map(t=>(
              <div key={t.id} className="txn">
                <div>
                  <div>{t.category}</div>
                  <small>{t.note}</small>
                </div>
                <div className={`amount ${t.type}`}>
                  {t.type==="income"?"+":"-"}à¸¿{t.amount.toFixed(2)}
                </div>
              </div>
            ))}
          </div>
        ))}

        {tab==="net" && (
          <>
            <p>Income: à¸¿{totalBy("income").toFixed(2)}</p>
            <p>Expense: à¸¿{totalBy("expense").toFixed(2)}</p>
            <p>Saving: à¸¿{totalBy("saving").toFixed(2)}</p>
            <p><b>Remaining: à¸¿{(totalBy("income")-totalBy("expense")-totalBy("saving")).toFixed(2)}</b></p>
          </>
        )}

        {tab==="usage" && settings.categories.map(c=>{
          const used = txns.filter(t=>t.category===c.name && t.type==="expense")
            .reduce((s,t)=>s+t.amount,0);
          return (
            <div key={c.name}>
              <div>{c.name} à¸¿{used}/{c.budget}</div>
              <div className="bar">
                <div style={{width:Math.min(100,(used/c.budget)*100)+"%"}}></div>
              </div>
            </div>
          );
        })}

        {tab==="pay" && settings.payments.map(p=>{
          const amt = txns.filter(t=>t.payment===p)
            .reduce((s,t)=>s+t.amount,0);
          return <p key={p}>{p}: à¸¿{amt.toFixed(2)}</p>;
        })}
      </main>

      <button className="fab" onClick={()=>setShowAdd(true)}>ï¼‹</button>

      <nav>
        <button onClick={()=>setTab("tx")} className={tab==="tx"?"active":""}>Txn</button>
        <button onClick={()=>setTab("net")} className={tab==="net"?"active":""}>Net</button>
        <button onClick={()=>setTab("usage")} className={tab==="usage"?"active":""}>Usage</button>
        <button onClick={()=>setTab("pay")} className={tab==="pay"?"active":""}>Pay</button>
      </nav>

      {showAdd && <AddTxn settings={settings} onSave={t=>{setTxns([t,...txns]);setShowAdd(false);}} onClose={()=>setShowAdd(false)} />}

      {showSettings && <Settings settings={settings} setSettings={setSettings} onClose={()=>setShowSettings(false)} />}

      {/* menuPage modals â€” moved inside App so they can access settings/setSettings */}
      {menuPage === "period" && (
        <div className="sheet">
          <h3>Period Settings</h3>

          <label>Cycle Name</label>
          <input value={settings.cycleName}
            onChange={e => setSettings({...settings, cycleName: e.target.value})} />

          <label>Start Day</label>
          <input type="number" value={settings.cycleStart}
            onChange={e => setSettings({...settings, cycleStart: +e.target.value})} />

          <label>End Day</label>
          <input type="number" value={settings.cycleEnd}
            onChange={e => setSettings({...settings, cycleEnd: +e.target.value})} />

          <button onClick={() => setMenuPage(null)}>Back</button>
        </div>
      )}

      {menuPage === "category" && (
        <div className="overlay">
          <div className="sheet">
            <h3>Category Settings</h3>

            {settings.categories.map((cat, idx) => (
              <div key={idx} style={{ marginBottom: 12 }}>
                <input
                  value={cat.name}
                  placeholder="Category name"
                  onChange={e => {
                    const copy = [...settings.categories];
                    copy[idx].name = e.target.value;
                    setSettings({ ...settings, categories: copy });
                  }}
                />

                <input
                  type="number"
                  placeholder="Budget (THB)"
                  value={cat.budget}
                  onChange={e => {
                    const copy = [...settings.categories];
                    copy[idx].budget = Number(e.target.value);
                    setSettings({ ...settings, categories: copy });
                  }}
                />

                <button
                  style={{ background: "#e53935", color: "#fff" }}
                  onClick={() => {
                    if (!confirm("Delete this category?")) return;
                    setSettings({
                      ...settings,
                      categories: settings.categories.filter((_, i) => i !== idx)
                    });
                  }}
                >
                  Delete
                </button>
              </div>
            ))}

            <button
              onClick={() =>
                setSettings({
                  ...settings,
                  categories: [
                    ...settings.categories,
                    { name: "ðŸ†• New Category", budget: 0 }
                  ]
                })
              }
            >
              + Add Category
            </button>

            <button onClick={() => setMenuPage(null)}>Back</button>
          </div>
        </div>
      )}
  
      {menuPage === "payment" && (
        <div className="overlay">
          <div className="sheet">
            <h3>Payment Methods</h3>

            {settings.payments.map((p, idx) => (
              <div key={idx} style={{ display: "flex", gap: 8 }}>
                <input
                  value={p}
                  onChange={e => {
                    const copy = [...settings.payments];
                    copy[idx] = e.target.value;
                    setSettings({ ...settings, payments: copy });
                  }}
                />

                <button
                  style={{ background: "#e53935", color: "#fff" }}
                  onClick={() => {
                    if (!confirm("Delete this payment method?")) return;
                    setSettings({
                      ...settings,
                      payments: settings.payments.filter((_, i) => i !== idx)
                    });
                  }}
                >
                  âœ•
                </button>
              </div>
            ))}

            <button
              onClick={() =>
                setSettings({
                  ...settings,
                  payments: [...settings.payments, "ðŸ†• New Method"]
                })
              }
            >
              + Add Payment Method
            </button>

            <button onClick={() => setMenuPage(null)}>Back</button>
          </div>
        </div>
      )}
    </>
  );
}

function AddTxn({settings,onSave,onClose}) {
  const [data,setData]=useState({
    type:"expense",
    amount:"",
    date:new Date().toISOString().slice(0,10),
    category:settings.categories[0].name,
    payment:settings.payments[0],
    note:""
  });

  return (
    <div className="overlay">
      <div className="sheet">
        <h3>Add Transaction</h3>

        <select onChange={e=>setData({...data,type:e.target.value})}>
          <option value="expense">Expense</option>
          <option value="income">Income</option>
          <option value="saving">Saving</option>
          <option value="charge">Charge</option>
        </select>

        <input type="number" step="0.01" placeholder="Amount"
          onChange={e=>setData({...data,amount:parseFloat(e.target.value)})} />

        <input type="date" value={data.date}
          onChange={e=>setData({...data,date:e.target.value})} />

        <select onChange={e=>setData({...data,category:e.target.value})}>
          {settings.categories.map(c=><option key={c.name}>{c.name}</option>)}
        </select>

        <select onChange={e=>setData({...data,payment:e.target.value})}>
          {settings.payments.map(p=><option key={p}>{p}</option>)}
        </select>

        <input placeholder="Description"
          onChange={e=>setData({...data,note:e.target.value})} />

        <button onClick={()=>onSave({id:Date.now(),...data})}>Save</button>
        <button onClick={onClose}>Cancel</button>
      </div>
    </div>
  );
}

function Settings({settings,setSettings,onClose}) {
  return (
    <div className="overlay">
      <div className="sheet">
        <h3>Master Settings</h3>

        <label>Cycle Name</label>
        <input value={settings.cycleName}
          onChange={e=>setSettings({...settings,cycleName:e.target.value})} />

        <label>Cycle Start</label>
        <input type="number" value={settings.cycleStart}
          onChange={e=>setSettings({...settings,cycleStart:+e.target.value})} />

        <label>Cycle End</label>
        <input type="number" value={settings.cycleEnd}
          onChange={e=>setSettings({...settings,cycleEnd:+e.target.value})} />

        <button onClick={onClose}>Close</button>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("app")).render(<App />);
</script>
</body>
</html>
